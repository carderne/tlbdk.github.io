---
layout: post
title:  "fscrypt setup on Ubuntu 18.10"
date:   2018-10-22 19:30:00 +0200
categories: FSCrypt
permalink: /ubuntu/2018/10/22/fscrypt.html
---

Check that block size matches page size, they should match:

``` bash
getconf PAGE_SIZE
tune2fs -l $DEVICE | grep 'Block size'
```

Enable encryption on EXT4:

``` bash
tune2fs -O encrypt /dev/device
```

Install fscrypt:

``` bash
sudo apt-get install fscrypt libpam-fscrypt
```

Fix keyinit session binding stuff:

/usr/share/pam-configs/keyinit-fix :

``` text
Name: keyinit fix
Default: yes
Priority: 0
Session-Type: Additional
Session:
	optional	pam_keyinit.so force revoke
```

Update pam files and then do logout and login to load the new pam files:

``` bash
sudo pam-auth-update
```

Setup fscrypt:

``` bash
sudo fscrypt setup # Global setup
fscrypt setup / # Partition setup
```

Test it on a folder and logout and login to see that the folder gets decrypted without having to type a password:

``` bash
mkdir encrypted
fscrypt encrypt encrypted # Select 1 - Your login passphrase (pam_passphrase)
``

Move home directory to encrypted folder:

``` bash
export USERNAME=user1
sudo su -
mv /home/$USERNAME /home/$USERNAME.bak
mkdir /home/$USERNAME
fscrypt encrypt /home/$USERNAME --user=$USERNAME
rsync -avH /home/$USERNAME.bak /home/$USERNAME
rm -rf /home/$USERNAME.bak
```